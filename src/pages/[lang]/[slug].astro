---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const allChapters = await getCollection('novel');
  const validChapters = allChapters.filter((entry: CollectionEntry<'novel'>) => entry.slug.includes('/'));

  return validChapters.map((chapter: CollectionEntry<'novel'>) => {
    const [lang, ...slugParts] = chapter.slug.split('/');
    const pageSlug = slugParts.join('/');

    const langChapters = validChapters
      .filter((c: CollectionEntry<'novel'>) => c.slug.startsWith(`${lang}/`))
      .sort((a: CollectionEntry<'novel'>, b: CollectionEntry<'novel'>) => {
        const numA = a.data.order ?? a.data.chapter_number ?? parseInt(a.slug.match(/\d+$/)?.[0] || "0");
        const numB = b.data.order ?? b.data.chapter_number ?? parseInt(b.slug.match(/\d+$/)?.[0] || "0");
        return numA - numB;
      });

    const currentIndex = langChapters.findIndex((c: CollectionEntry<'novel'>) => c.slug === chapter.slug);
    const prev = currentIndex > 0 ? langChapters[currentIndex - 1] : null;
    const next = currentIndex < langChapters.length - 1 ? langChapters[currentIndex + 1] : null;

    const getLinkSlug = (entry: CollectionEntry<'novel'>) => entry.slug.split('/').slice(1).join('/');

    return {
      params: { lang, slug: pageSlug },
      props: { 
        chapter,
        prevSlug: prev ? getLinkSlug(prev) : null,
        nextSlug: next ? getLinkSlug(next) : null
      },
    };
  });
}

const { lang } = Astro.params;
const { chapter, prevSlug, nextSlug } = Astro.props;
const { Content } = await chapter.render();

const title = chapter.data.title || "Untitled";
const filenameNum = chapter.slug.match(/(\d+)$/)?.[0];
const chapterNum = chapter.data.order ?? chapter.data.chapter_number ?? filenameNum ?? "";
---

<Layout title={title}>
  <div class="progress-container"><div class="progress-bar" id="myBar"></div></div>

  <div id="sticky-header" class="sticky-header">
    <span class="sticky-text">
      <span class="sticky-num">Chapter {chapterNum}</span>
      <span class="sticky-divider">|</span>
      {title}
    </span>
  </div>

  <div class="chapter-container">
    <div id="main-header" class="chapter-header">
      <span class="chapter-number">Chapter <span id="raw-num">{chapterNum}</span></span>
      <h1 id="raw-title" transition:name={`title-${lang}-${chapterNum}`}>{title}</h1>
    </div>
    
    <hr class="separator" />
    
    <article id="novel-content" class="chapter-text">
      <Content /> 
    </article>

    <nav class="nav-buttons">
      {prevSlug ? (
        <a href={`/${lang}/${prevSlug}`} class="nav-btn-link" title="Previous">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
        </a>
      ) : (
        <span class="nav-btn-link disabled">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
        </span>
      )}

      <div class="nav-section-divider" id="theme-drawer-wrapper">
        <button class="nav-action-btn" id="theme-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
        </button>
        <div class="theme-menu-box" id="theme-menu">
          <button class="color-dot light" data-set-t="light"></button>
          <button class="color-dot sepia" data-set-t="sepia"></button>
          <button class="color-dot dark" data-set-t="dark"></button>
        </div>
      </div>

      <div class="nav-section-divider zoom-wrapper">
        <button class="zoom-text-btn" id="z-out">A-</button>
        <button class="zoom-text-btn" id="z-in">A+</button>
      </div>

      <a href="/" class="nav-btn-link nav-section-divider" title="Home">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      </a>

      {nextSlug ? (
        <a href={`/${lang}/${nextSlug}`} class="nav-btn-link nav-section-divider" title="Next">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
        </a>
      ) : (
        <span class="nav-btn-link disabled nav-section-divider">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
        </span>
      )}
    </nav>
  </div>
</Layout>

<script is:inline>
  function runNovelScripts() {
    const trigger = document.getElementById('theme-trigger');
    const menu = document.getElementById('theme-menu');
    const dots = document.querySelectorAll('[data-set-t]');

    if (trigger && menu) {
      trigger.onclick = (e) => {
        e.stopPropagation();
        menu.classList.toggle('open');
      };
    }

    dots.forEach(dot => {
      dot.onclick = (e) => {
        e.stopPropagation();
        const theme = dot.getAttribute('data-set-t');
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('novel-theme', theme);
        menu?.classList.remove('open');
      };
    });

    const zIn = document.getElementById('z-in');
    const zOut = document.getElementById('z-out');
    const content = document.getElementById('novel-content');

    const changeSize = (amt) => {
      let cur = parseFloat(localStorage.getItem('novel-font-size')) || 1.2;
      cur = Math.max(0.8, Math.min(2.5, cur + amt));
      if (content) content.style.fontSize = cur + "rem";
      localStorage.setItem('novel-font-size', cur);
    };

    if (zIn) zIn.onclick = () => changeSize(0.1);
    if (zOut) zOut.onclick = () => changeSize(-0.1);

    const savedT = localStorage.getItem('novel-theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedT);
    const savedS = localStorage.getItem('novel-font-size') || 1.2;
    if (content) content.style.fontSize = savedS + "rem";
  }

  function handleScroll() {
    const win = document.documentElement.scrollTop;
    const total = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    if (total <= 0) return;
    const pct = (win / total) * 100;
    const bar = document.getElementById("myBar");
    if (bar) bar.style.width = pct + "%";

    if (pct > 95) {
      const path = window.location.pathname.replace(/\/$/, "");
      localStorage.setItem('finished-' + path, 'true');
    }
  }

  document.addEventListener('astro:page-load', () => {
    runNovelScripts();
    window.addEventListener('scroll', handleScroll);
  });
</script>

<style is:global>
  :root, [data-theme="light"] {
    --bg-color: #ffffff; --text-color: #222222; --meta-color: #666666;
    --nav-bg: rgba(255, 255, 255, 0.95); --border-color: #dddddd;
    --sticky-bg: rgba(255, 255, 255, 0.98); --accent: #007aff;
  }
  [data-theme="sepia"] {
    --bg-color: #f4ecd8; --text-color: #5b4636; --meta-color: #8c786a;
    --nav-bg: rgba(244, 236, 216, 0.95); --border-color: #d3c9b1;
    --sticky-bg: rgba(244, 236, 216, 0.98); --accent: #8c786a;
  }
  [data-theme="dark"] {
    --bg-color: #1a1a1a; --text-color: #e0e0e0; --meta-color: #999999;
    --nav-bg: rgba(40, 40, 40, 0.95); --border-color: #444444;
    --sticky-bg: rgba(26, 26, 26, 0.98); --accent: #bb86fc;
  }
  html, body { background-color: var(--bg-color) !important; color: var(--text-color); margin: 0; padding: 0; width: 100%; }
</style>

<style>
  .progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 4px; z-index: 2202; background: transparent; }
  .progress-bar { height: 4px; background: var(--accent); width: 0%; transition: width 0.1s ease-out; }
  .sticky-header {
    position: fixed; top: 0; left: 0; width: 100%; height: 60px;
    background: var(--sticky-bg); border-bottom: 1px solid var(--border-color);
    display: flex; align-items: center; justify-content: center;
    z-index: 900; transform: translateY(-100%); transition: transform 0.3s;
    backdrop-filter: blur(10px);
  }
  .sticky-header.visible { transform: translateY(0); }
  .sticky-text { font-family: 'Georgia', serif; font-size: 1rem; }
  .sticky-num { font-weight: bold; opacity: 0.7; margin-right: 10px; text-transform: uppercase; font-size: 0.8rem; }
  .sticky-divider { margin-right: 10px; opacity: 0.3; }
  .chapter-container { max-width: 800px; margin: 0 auto; padding: 4rem 1.5rem 150px 1.5rem; font-family: 'Georgia', serif; }
  .chapter-header { text-align: center; margin-bottom: 3rem; }
  .chapter-number { color: var(--meta-color); text-transform: uppercase; letter-spacing: 2px; font-size: 0.9rem; }
  .chapter-header h1 { font-size: 2.5rem; margin-top: 0.5rem; }
  .separator { border: 0; border-top: 1px solid var(--border-color); width: 100px; margin: 2rem auto; }
  .chapter-text { font-size: 1.2rem; line-height: 1.8; transition: font-size 0.2s ease; }
  .chapter-text :global(p) { margin-bottom: 1.5em; text-align: justify; }

  .nav-buttons {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
    background: var(--nav-bg); backdrop-filter: blur(15px);
    height: 50px; border: 1px solid var(--border-color);
    border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    display: flex; align-items: center; justify-content: center; z-index: 1000;
    overflow: hidden; padding: 0 5px;
  }
  .nav-btn-link, #theme-drawer-wrapper, .zoom-wrapper { display: inline-flex; align-items: center; justify-content: center; height: 100%; }
  .nav-section-divider { border-left: 1px solid var(--border-color) !important; }
  .nav-btn-link, .nav-action-btn { width: 50px; background: transparent; border: none; cursor: pointer; text-decoration: none; color: inherit; display: flex; align-items: center; justify-content: center; }
  .nav-btn-link svg, .nav-action-btn svg { stroke: var(--text-color); }
  .nav-btn-link.disabled { opacity: 0.2; pointer-events: none; }

  #theme-drawer-wrapper { position: relative; }
  .theme-menu-box {
    position: absolute; bottom: 65px; left: 50%; transform: translateX(-50%) translateY(10px);
    background: var(--nav-bg); border: 1px solid var(--border-color);
    padding: 12px; border-radius: 20px; display: flex; gap: 12px;
    opacity: 0; pointer-events: none; transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    align-items: center; z-index: 1001;
  }
  .theme-menu-box.open { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }
  .color-dot { width: 24px; height: 24px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.2); cursor: pointer; padding: 0; flex-shrink: 0; }
  .color-dot.light { background: #fff !important; }
  .color-dot.sepia { background: #f4ecd8 !important; }
  .color-dot.dark { background: #333 !important; }

  .zoom-wrapper { padding: 0 12px; gap: 12px; }
  .zoom-text-btn { background: transparent !important; border: none; font-family: sans-serif; font-weight: bold; font-size: 0.85rem; color: var(--text-color); cursor: pointer; }
</style>