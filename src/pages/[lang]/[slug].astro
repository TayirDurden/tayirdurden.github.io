---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const allChapters = await getCollection('novel');
  const validChapters = allChapters.filter(entry => entry.slug.includes('/'));

  return validChapters.map(chapter => {
    const [lang, ...slugParts] = chapter.slug.split('/');
    const pageSlug = slugParts.join('/');

    const langChapters = validChapters
      .filter(c => c.slug.startsWith(`${lang}/`))
      .sort((a, b) => {
        const numA = a.data.order ?? a.data.chapter_number ?? parseInt(a.slug.match(/\d+$/)?.[0] || "0");
        const numB = b.data.order ?? b.data.chapter_number ?? parseInt(b.slug.match(/\d+$/)?.[0] || "0");
        return numA - numB;
      });

    const currentIndex = langChapters.findIndex(c => c.slug === chapter.slug);
    const prev = currentIndex > 0 ? langChapters[currentIndex - 1] : null;
    const next = currentIndex < langChapters.length - 1 ? langChapters[currentIndex + 1] : null;

    const getLinkSlug = (entry) => entry.slug.split('/').slice(1).join('/');

    return {
      params: { lang, slug: pageSlug },
      props: { 
        chapter,
        prevSlug: prev ? getLinkSlug(prev) : null,
        nextSlug: next ? getLinkSlug(next) : null
      },
    };
  });
}

const { lang } = Astro.params;
const { chapter, prevSlug, nextSlug } = Astro.props;
const { Content } = await chapter.render();

const title = chapter.data.title || "Untitled";
const filenameNum = chapter.slug.match(/(\d+)$/)?.[0];
const chapterNum = chapter.data.order ?? chapter.data.chapter_number ?? filenameNum ?? "";
---

<Layout title={title}>
  <div class="progress-container"><div class="progress-bar" id="myBar"></div></div>

  <div id="sticky-header" class="sticky-header">
    <span class="sticky-text">
      <span class="sticky-num">Chapter {chapterNum}</span>
      <span class="sticky-divider">|</span>
      {title}
    </span>
  </div>

  <div class="chapter-container">
    <div id="main-header" class="chapter-header">
      <span class="chapter-number">Chapter <span id="raw-num">{chapterNum}</span></span>
      <h1 id="raw-title" transition:name={`title-${lang}-${chapterNum}`}>{title}</h1>
    </div>
    
    <hr class="separator" />
    
    <article id="novel-content" class="chapter-text">
      <Content /> 
    </article>

    <nav class="nav-buttons">
      {prevSlug ? (
        <a href={`/${lang}/${prevSlug}`} class="btn icon-btn" title="Previous">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
        </a>
      ) : (
        <span class="btn icon-btn disabled">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
        </span>
      )}

      <div class="theme-drawer-container section-divider" id="theme-drawer">
        <button class="btn theme-toggle-btn" id="theme-master-btn" title="Appearance">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
        </button>
        <div class="theme-options">
          <button class="theme-btn light" data-theme-set="light"></button>
          <button class="theme-btn sepia" data-theme-set="sepia"></button>
          <button class="theme-btn dark" data-theme-set="dark"></button>
        </div>
      </div>

      <div class="zoom-controls section-divider">
        <button class="btn zoom-btn" id="zoom-out">A-</button>
        <button class="btn zoom-btn" id="zoom-in">A+</button>
      </div>

      <a href="/" class="btn home section-divider" title="Library">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      </a>

      {nextSlug ? (
        <a href={`/${lang}/${nextSlug}`} class="btn icon-btn section-divider" title="Next">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
        </a>
      ) : (
        <span class="btn icon-btn disabled section-divider">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
        </span>
      )}
    </nav>
  </div>
</Layout>

<script is:inline>
  function initReaderLogic() {
    const masterBtn = document.getElementById('theme-master-btn');
    const drawer = document.getElementById('theme-drawer');
    const themeButtons = document.querySelectorAll('[data-theme-set]');
    const zoomIn = document.getElementById('zoom-in');
    const zoomOut = document.getElementById('zoom-out');
    const content = document.getElementById('novel-content');

    // Attach Theme Toggle
    if (masterBtn && drawer) {
      masterBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        drawer.classList.toggle('active');
      });
    }

    // Attach Theme Switches
    themeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const theme = btn.getAttribute('data-theme-set');
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('novel-theme', theme);
        drawer?.classList.remove('active');
      });
    });

    // Attach Zoom
    const updateSize = (change) => {
      let current = parseFloat(localStorage.getItem('novel-font-size')) || 1.2;
      current = Math.max(0.8, Math.min(2.5, current + change));
      if (content) content.style.fontSize = current + "rem";
      localStorage.setItem('novel-font-size', current);
    };
    zoomIn?.addEventListener('click', () => updateSize(0.1));
    zoomOut?.addEventListener('click', () => updateSize(-0.1));

    // Initial Load from Storage
    const savedTheme = localStorage.getItem('novel-theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    const savedSize = localStorage.getItem('novel-font-size') || 1.2;
    if (content) content.style.fontSize = savedSize + "rem";

    // Progress
    const num = document.getElementById('raw-num')?.innerText || "";
    const title = document.getElementById('raw-title')?.innerText || "";
    if (num && title) {
      localStorage.setItem('last-read-path', window.location.pathname);
      localStorage.setItem('last-read-title', "Chapter " + num + ": " + title);
    }
  }

  function updateScroll() {
    const winScroll = document.documentElement.scrollTop;
    const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    if (height <= 0) return;
    const scrolled = (winScroll / height) * 100;
    const bar = document.getElementById("myBar");
    if (bar) bar.style.width = scrolled + "%";
    if (scrolled > 95) {
      const path = window.location.pathname.replace(/\/$/, "");
      localStorage.setItem('finished-' + path, 'true');
    }
  }

  document.addEventListener('astro:page-load', () => {
    initReaderLogic();
    window.addEventListener('scroll', updateScroll);
    
    // Sticky Header Logic
    const stickyHeader = document.getElementById('sticky-header');
    const mainHeader = document.getElementById('main-header');
    if (stickyHeader && mainHeader) {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (!entry.isIntersecting) stickyHeader.classList.add('visible');
          else stickyHeader.classList.remove('visible');
        });
      }, { threshold: 0 });
      observer.observe(mainHeader);
    }
  });

  document.addEventListener('click', (e) => {
    const drawer = document.getElementById('theme-drawer');
    if (drawer && !drawer.contains(e.target)) drawer.classList.remove('active');
  });
</script>

<style is:global>
  :root, [data-theme="light"] {
    --bg-color: #ffffff; --text-color: #222222; --meta-color: #666666;
    --nav-bg: rgba(255, 255, 255, 0.95); --border-color: #dddddd;
    --sticky-bg: rgba(255, 255, 255, 0.98); --accent: #007aff;
  }
  [data-theme="sepia"] {
    --bg-color: #f4ecd8; --text-color: #5b4636; --meta-color: #8c786a;
    --nav-bg: rgba(244, 236, 216, 0.95); --border-color: #d3c9b1;
    --sticky-bg: rgba(244, 236, 216, 0.98); --accent: #8c786a;
  }
  [data-theme="dark"] {
    --bg-color: #1a1a1a; --text-color: #e0e0e0; --meta-color: #999999;
    --nav-bg: rgba(40, 40, 40, 0.95); --border-color: #444444;
    --sticky-bg: rgba(26, 26, 26, 0.98); --accent: #bb86fc;
  }
  html, body { background-color: var(--bg-color) !important; color: var(--text-color); margin: 0; padding: 0; width: 100%; }
</style>

<style>
  .progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 4px; z-index: 2202; background: transparent; }
  .progress-bar { height: 4px; background: var(--accent); width: 0%; transition: width 0.1s ease-out; }
  .sticky-header {
    position: fixed; top: 0; left: 0; width: 100%; height: 60px;
    background: var(--sticky-bg); border-bottom: 1px solid var(--border-color);
    display: flex; align-items: center; justify-content: center;
    z-index: 900; transform: translateY(-100%); transition: transform 0.3s;
    backdrop-filter: blur(10px);
  }
  .sticky-header.visible { transform: translateY(0); }
  .sticky-text { font-family: 'Georgia', serif; font-size: 1rem; }
  .sticky-num { font-weight: bold; opacity: 0.7; margin-right: 10px; text-transform: uppercase; font-size: 0.8rem; }
  .sticky-divider { margin-right: 10px; opacity: 0.3; }
  .chapter-container { max-width: 800px; margin: 0 auto; padding: 4rem 1.5rem 150px 1.5rem; font-family: 'Georgia', serif; }
  .chapter-header { text-align: center; margin-bottom: 3rem; }
  .chapter-number { color: var(--meta-color); text-transform: uppercase; letter-spacing: 2px; font-size: 0.9rem; }
  .chapter-header h1 { font-size: 2.5rem; margin-top: 0.5rem; }
  .separator { border: 0; border-top: 1px solid var(--border-color); width: 100px; margin: 2rem auto; }
  .chapter-text { font-size: 1.2rem; line-height: 1.8; transition: font-size 0.2s ease; }
  .chapter-text :global(p) { margin-bottom: 1.5em; text-align: justify; }
  .nav-buttons {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
    background: var(--nav-bg); backdrop-filter: blur(15px);
    height: 50px; border: 1px solid var(--border-color);
    border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    display: flex; align-items: center; justify-content: center; z-index: 1000;
    overflow: hidden; padding: 0 5px;
  }
  .btn, .theme-drawer-container, .zoom-controls { display: inline-flex; align-items: center; justify-content: center; height: 100%; }
  .section-divider { border-left: 1px solid var(--border-color) !important; }
  .btn.icon-btn, .btn.home, .theme-toggle-btn { width: 50px; cursor: pointer; background: transparent; border: none; }
  .btn svg { stroke: var(--text-color); transition: transform 0.2s; }
  .btn:hover svg { transform: scale(1.15); }
  .btn.disabled { opacity: 0.2; pointer-events: none; }
  .theme-drawer-container { position: relative; }
  .theme-options {
    position: absolute; bottom: 65px; left: 50%; transform: translateX(-50%) translateY(10px);
    background: var(--nav-bg); border: 1px solid var(--border-color);
    padding: 12px; border-radius: 20px; display: flex; gap: 12px;
    opacity: 0; pointer-events: none; transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    z-index: 1001; align-items: center;
  }
  .theme-drawer-container.active .theme-options { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }
  .theme-btn { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 1px solid rgba(0,0,0,0.2); flex-shrink: 0; }
  .theme-btn.light { background-color: #ffffff !important; }
  .theme-btn.sepia { background-color: #f4ecd8 !important; }
  .theme-btn.dark { background-color: #333333 !important; }
  .zoom-controls { padding: 0 12px; gap: 12px; }
  .zoom-btn { font-family: sans-serif; font-weight: bold; font-size: 0.85rem; color: var(--text-color); }
</style>