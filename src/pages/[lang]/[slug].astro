---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const allChapters = await getCollection('novel');
  const validChapters = allChapters.filter(entry => entry.slug.includes('/'));

  return validChapters.map(chapter => {
    const [lang, ...slugParts] = chapter.slug.split('/');
    const pageSlug = slugParts.join('/');

    const langChapters = validChapters
      .filter(c => c.slug.startsWith(`${lang}/`))
      .sort((a, b) => {
        const numA = a.data.order ?? a.data.chapter_number ?? parseInt(a.slug.match(/\d+$/)?.[0] || "0");
        const numB = b.data.order ?? b.data.chapter_number ?? parseInt(b.slug.match(/\d+$/)?.[0] || "0");
        return numA - numB;
      });

    const currentIndex = langChapters.findIndex(c => c.slug === chapter.slug);
    const prev = currentIndex > 0 ? langChapters[currentIndex - 1] : null;
    const next = currentIndex < langChapters.length - 1 ? langChapters[currentIndex + 1] : null;

    const getLinkSlug = (entry) => entry.slug.split('/').slice(1).join('/');

    return {
      params: { lang, slug: pageSlug },
      props: { 
        chapter,
        prevSlug: prev ? getLinkSlug(prev) : null,
        nextSlug: next ? getLinkSlug(next) : null
      },
    };
  });
}

const { lang } = Astro.params;
const { chapter, prevSlug, nextSlug } = Astro.props;
const { Content } = await chapter.render();

const title = chapter.data.title || "Untitled";
const filenameNum = chapter.slug.match(/(\d+)$/)?.[0];
const chapterNum = chapter.data.order ?? chapter.data.chapter_number ?? filenameNum ?? "";
---

<Layout title={title}>
  <div class="progress-container"><div class="progress-bar" id="myBar"></div></div>

  <div id="sticky-header" class="sticky-header">
    <span class="sticky-text">
      <span class="sticky-num">Chapter {chapterNum}</span>
      <span class="sticky-divider">|</span>
      {title}
    </span>
  </div>

  <div class="chapter-container">
    <div id="main-header" class="chapter-header">
      <span class="chapter-number">Chapter <span id="raw-num">{chapterNum}</span></span>
      <h1 id="raw-title" transition:name={`title-${lang}-${chapterNum}`}>{title}</h1>
    </div>
    
    <hr class="separator" />
    
    <article id="novel-content" class="chapter-text">
      <Content /> 
    </article>

    <nav class="nav-buttons">
      {prevSlug ? (
        <a href={`/${lang}/${prevSlug}`} class="btn icon-btn">‚Üê</a>
      ) : (
        <span class="btn icon-btn disabled">‚Üê</span>
      )}

      <div class="theme-drawer-container" id="theme-drawer">
        <button class="btn theme-toggle-btn" onclick="toggleThemeDrawer()" title="Change Theme">üé®</button>
        <div class="theme-options">
          <button class="theme-btn light" onclick="setTheme('light')"></button>
          <button class="theme-btn sepia" onclick="setTheme('sepia')"></button>
          <button class="theme-btn dark" onclick="setTheme('dark')"></button>
        </div>
      </div>

      <div class="zoom-controls">
        <button class="btn zoom-btn" onclick="adjustFontSize(-0.1)">A-</button>
        <button class="btn zoom-btn" onclick="adjustFontSize(0.1)">A+</button>
      </div>

      <a href="/" class="btn home">üïÆ</a>

      {nextSlug ? (
        <a href={`/${lang}/${nextSlug}`} class="btn icon-btn">‚Üí</a>
      ) : (
        <span class="btn icon-btn disabled">‚Üí</span>
      )}
    </nav>
  </div>
</Layout>

<script is:inline>
  function updateScroll() {
    const winScroll = document.documentElement.scrollTop;
    const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    if (height <= 0) return;
    const scrolled = (winScroll / height) * 100;
    const bar = document.getElementById("myBar");
    if(bar) bar.style.width = scrolled + "%";

    if (scrolled > 95) {
      localStorage.setItem('finished-' + window.location.pathname, 'true');
    }
  }

  function initReader() {
    const num = document.getElementById('raw-num')?.innerText || "";
    const mainTitle = document.getElementById('raw-title')?.innerText || "";
    
    // PERSISTENCE FIX: Save immediately on load
    if (num && mainTitle) {
      localStorage.setItem('last-read-path', window.location.pathname);
      localStorage.setItem('last-read-title', `Chapter ${num}: ${mainTitle}`);
    }

    setTheme(localStorage.getItem('novel-theme') || 'light');
    
    let currentSize = parseFloat(localStorage.getItem('novel-font-size')) || 1.2;
    const content = document.getElementById('novel-content');
    if (content) content.style.fontSize = `${currentSize}rem`;
    
    window.addEventListener('scroll', updateScroll);
  }

  function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('novel-theme', theme);
    const drawer = document.getElementById('theme-drawer');
    if(drawer) drawer.classList.remove('active');
  }

  function toggleThemeDrawer() {
    const drawer = document.getElementById('theme-drawer');
    if(drawer) drawer.classList.toggle('active');
  }

  function adjustFontSize(change) {
    let currentSize = parseFloat(localStorage.getItem('novel-font-size')) || 1.2;
    currentSize += change;
    if (currentSize < 0.8) currentSize = 0.8;
    if (currentSize > 2.5) currentSize = 2.5;
    const content = document.getElementById('novel-content');
    if (content) content.style.fontSize = `${currentSize}rem`;
    localStorage.setItem('novel-font-size', currentSize);
  }

  document.addEventListener('astro:page-load', () => {
    initReader();
    
    const stickyHeader = document.getElementById('sticky-header');
    const mainHeader = document.getElementById('main-header');
    if (stickyHeader && mainHeader) {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (!entry.isIntersecting) stickyHeader.classList.add('visible');
          else stickyHeader.classList.remove('visible');
        });
      }, { threshold: 0 });
      observer.observe(mainHeader);
    }
  });
</script>

<style is:global>
  :root, [data-theme="light"] {
    --bg-color: #ffffff; --text-color: #222222; --meta-color: #666666;
    --nav-bg: rgba(255, 255, 255, 0.95); --border-color: #dddddd;
    --sticky-bg: rgba(255, 255, 255, 0.98); --accent: #007aff;
  }
  [data-theme="sepia"] {
    --bg-color: #f4ecd8; --text-color: #5b4636; --meta-color: #8c786a;
    --nav-bg: rgba(244, 236, 216, 0.95); --border-color: #d3c9b1;
    --sticky-bg: rgba(244, 236, 216, 0.98); --accent: #8c786a;
  }
  [data-theme="dark"] {
    --bg-color: #1a1a1a; --text-color: #e0e0e0; --meta-color: #999999;
    --nav-bg: rgba(40, 40, 40, 0.95); --border-color: #444444;
    --sticky-bg: rgba(26, 26, 26, 0.98); --accent: #bb86fc;
  }
  html, body { background-color: var(--bg-color) !important; color: var(--text-color); margin: 0; padding: 0; }
</style>

<style>
  .progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 4px; z-index: 2202; background: transparent; }
  .progress-bar { height: 4px; background: var(--accent); width: 0%; transition: width 0.1s ease-out; }
  .sticky-header {
    position: fixed; top: 0; left: 0; width: 100%; height: 60px;
    background: var(--sticky-bg); border-bottom: 1px solid var(--border-color);
    display: flex; align-items: center; justify-content: center;
    z-index: 900; transform: translateY(-100%); transition: transform 0.3s;
    backdrop-filter: blur(10px);
  }
  .sticky-header.visible { transform: translateY(0); }
  .sticky-text { font-family: 'Georgia', serif; font-size: 1rem; }
  .sticky-num { font-weight: bold; opacity: 0.7; margin-right: 10px; text-transform: uppercase; font-size: 0.8rem; }
  .sticky-divider { margin-right: 10px; opacity: 0.3; }
  .chapter-container { max-width: 800px; margin: 0 auto; padding: 4rem 1.5rem 150px 1.5rem; font-family: 'Georgia', serif; }
  .chapter-header { text-align: center; margin-bottom: 3rem; }
  .chapter-number { color: var(--meta-color); text-transform: uppercase; letter-spacing: 2px; font-size: 0.9rem; }
  .chapter-header h1 { font-size: 2.5rem; margin-top: 0.5rem; }
  .separator { border: 0; border-top: 1px solid var(--border-color); width: 100px; margin: 2rem auto; }
  .chapter-text { font-size: 1.2rem; line-height: 1.8; transition: font-size 0.2s ease; }
  .chapter-text :global(p) { margin-bottom: 1.5em; text-align: justify; }
  .nav-buttons {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
    background: var(--nav-bg); backdrop-filter: blur(15px);
    padding: 0.6rem 1.2rem; border: 1px solid var(--border-color);
    border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    display: flex; align-items: center; gap: 15px; z-index: 1000;
  }
  .theme-drawer-container { position: relative; display: flex; align-items: center; }
  .theme-toggle-btn { border-left: 1px solid var(--border-color); border-right: 1px solid var(--border-color); padding: 0 10px; font-size: 1.1rem; cursor: pointer; background: transparent; color: var(--text-color); }
  .theme-options {
    position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%) translateY(10px);
    background: var(--nav-bg); border: 1px solid var(--border-color);
    padding: 12px; border-radius: 20px; display: flex; gap: 12px;
    opacity: 0; pointer-events: none; transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  }
  .theme-drawer-container.active .theme-options { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }
  .theme-btn { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 1px solid rgba(0,0,0,0.2); padding: 0; }
  .zoom-controls { display: flex; gap: 8px; border-right: 1px solid var(--border-color); padding-right: 10px; }
  .btn { background: transparent; border: none; color: var(--text-color); cursor: pointer; font-family: sans-serif; font-size: 0.9rem; text-decoration: none; display: flex; align-items: center; }
  .icon-btn { font-size: 1.3rem; }
  .btn.disabled { opacity: 0.2; pointer-events: none; }
  .btn.home { font-size: 1.2rem; }
</style>