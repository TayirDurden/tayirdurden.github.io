---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const allChapters = await getCollection('novel');
  const validChapters = allChapters.filter((entry: CollectionEntry<'novel'>) => entry.slug.includes('/'));

  return validChapters.map((chapter: CollectionEntry<'novel'>) => {
    const [lang, ...slugParts] = chapter.slug.split('/');
    const pageSlug = slugParts.join('/');

    const langChapters = validChapters
      .filter((c: CollectionEntry<'novel'>) => c.slug.startsWith(`${lang}/`))
      .sort((a: CollectionEntry<'novel'>, b: CollectionEntry<'novel'>) => {
        const numA = a.data.order ?? a.data.chapter_number ?? parseInt(a.slug.match(/\d+$/)?.[0] || "0");
        const numB = b.data.order ?? b.data.chapter_number ?? parseInt(b.slug.match(/\d+$/)?.[0] || "0");
        return numA - numB;
      });

    const currentIndex = langChapters.findIndex((c: CollectionEntry<'novel'>) => c.slug === chapter.slug);
    const prev = currentIndex > 0 ? langChapters[currentIndex - 1] : null;
    const next = currentIndex < langChapters.length - 1 ? langChapters[currentIndex + 1] : null;

    const getLinkSlug = (entry: CollectionEntry<'novel'>) => entry.slug.split('/').slice(1).join('/');

    return {
      params: { lang, slug: pageSlug },
      props: { 
        chapter,
        prevSlug: prev ? getLinkSlug(prev) : null,
        nextSlug: next ? getLinkSlug(next) : null
      },
    };
  });
}

const { lang } = Astro.params;
const { chapter, prevSlug, nextSlug } = Astro.props;
const { Content } = await chapter.render();

const title = chapter.data.title || "Untitled";
const filenameNum = chapter.slug.match(/(\d+)$/)?.[0];
const chapterNum = chapter.data.order ?? chapter.data.chapter_number ?? filenameNum ?? "";
---

<Layout title={title}>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700;1,400&family=EB+Garamond:ital,wght@0,400;0,700;1,400&family=Merriweather:ital,wght@0,400;0,700;1,400&family=Crimson+Pro:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

  <div class="progress-container"><div class="progress-bar" id="myBar"></div></div>

  <div id="sticky-header" class="sticky-header">
    <span class="sticky-text">
      <span class="sticky-num">Chapter {chapterNum}</span>
      <span class="sticky-divider">|</span>
      {title}
    </span>
  </div>

  <div class="chapter-container">
    <div id="main-header" class="chapter-header">
      <span class="chapter-number">Chapter <span id="raw-num">{chapterNum}</span></span>
      <h1 id="raw-title" transition:name={`title-${lang}-${chapterNum}`}>{title}</h1>
    </div>
    
    <hr class="separator" />
    
    <article id="novel-content" class="chapter-text">
      <Content /> 
    </article>

    <nav class="nav-buttons">
      {prevSlug ? (
        <a href={`/${lang}/${prevSlug}`} class="nav-btn" title="Previous">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
        </a>
      ) : (
        <span class="nav-btn disabled">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
        </span>
      )}

      <div class="drawer-wrap section-divider">
        <button class="nav-btn" id="theme-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
        </button>
        <div class="drawer theme-menu" id="theme-menu">
          <button class="dot light" data-set-theme="light"></button>
          <button class="dot sepia" data-set-theme="sepia"></button>
          <button class="dot dark" data-set-theme="dark"></button>
        </div>
      </div>

      <div class="drawer-wrap section-divider">
        <button class="nav-btn" id="font-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>
        </button>
        <div class="drawer font-menu" id="font-menu">
            <button class="f-opt" data-set-font="Lora" style="font-family:'Lora'">Lora</button>
            <button class="f-opt" data-set-font="EB Garamond" style="font-family:'EB Garamond'">Garamond</button>
            <button class="f-opt" data-set-font="Merriweather" style="font-family:'Merriweather'">Merriweather</button>
            <button class="f-opt" data-set-font="Inter" style="font-family:'Inter'">Inter</button>
            <button class="f-opt" data-set-font="JetBrains Mono" style="font-family:'JetBrains Mono'">Mono</button>
        </div>
      </div>

      <div class="zoom-wrap section-divider">
        <button class="z-btn" id="z-out">A-</button>
        <button class="z-btn" id="z-in">A+</button>
      </div>

      <a href="/" class="nav-btn section-divider" title="Home">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      </a>

      {nextSlug ? (
        <a href={`/${lang}/${nextSlug}`} class="nav-btn section-divider" title="Next">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
        </a>
      ) : (
        <span class="nav-btn disabled section-divider">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
        </span>
      )}
    </nav>
  </div>
</Layout>

<script is:inline>
  const applyT = (t) => { document.documentElement.setAttribute('data-theme', t); localStorage.setItem('novel-theme', t); };
  const applyF = (f) => { 
    const c = document.getElementById('novel-content'); 
    if (c) c.style.fontFamily = f + (f === 'Inter' ? ', sans-serif' : (f === 'JetBrains Mono' ? ', monospace' : ', serif')); 
    localStorage.setItem('novel-font', f);
  };
  const applyS = (s) => { 
    const c = document.getElementById('novel-content');
    if (c) c.style.fontSize = s + "rem";
    localStorage.setItem('novel-font-size', s);
  };

  if (!window.readerInitialized) {
    document.addEventListener('click', (e) => {
      const t = e.target;
      if (t.closest('#theme-trigger')) { e.stopPropagation(); document.getElementById('font-menu').classList.remove('open'); document.getElementById('theme-menu').classList.toggle('open'); return; }
      if (t.closest('#font-trigger')) { e.stopPropagation(); document.getElementById('theme-menu').classList.remove('open'); document.getElementById('font-menu').classList.toggle('open'); return; }
      const tBtn = t.closest('[data-set-theme]');
      if (tBtn) { applyT(tBtn.getAttribute('data-set-theme')); document.getElementById('theme-menu').classList.remove('open'); return; }
      const fBtn = t.closest('[data-set-font]');
      if (fBtn) { applyF(fBtn.getAttribute('data-set-font')); document.getElementById('font-menu').classList.remove('open'); return; }
      if (t.closest('#z-in') || t.closest('#z-out')) {
        let cur = parseFloat(localStorage.getItem('novel-font-size')) || 1.2;
        applyS(Math.max(0.8, Math.min(2.5, t.closest('#z-in') ? cur + 0.1 : cur - 0.1)));
        return;
      }
      document.getElementById('theme-menu').classList.remove('open');
      document.getElementById('font-menu').classList.remove('open');
    });
    window.readerInitialized = true;
  }

  document.addEventListener('astro:page-load', () => {
    applyT(localStorage.getItem('novel-theme') || 'light');
    applyF(localStorage.getItem('novel-font') || 'Lora');
    applyS(localStorage.getItem('novel-font-size') || 1.2);
    
    const sticky = document.getElementById('sticky-header'), main = document.getElementById('main-header');
    if (sticky && main) {
      new IntersectionObserver(([e]) => sticky.classList.toggle('visible', !e.isIntersecting)).observe(main);
    }
  });

  window.onscroll = () => {
    const win = document.documentElement.scrollTop, ht = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    const bar = document.getElementById("myBar");
    if (bar && ht > 0) bar.style.width = (win / ht) * 100 + "%";
  };
</script>

<style is:global>
  :root, [data-theme="light"] { --bg-color: #fff; --text-color: #222; --border-color: #ddd; --sticky-bg: rgba(255,255,25