---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../layouts/Layout.astro';

const allChapters = await getCollection('novel');

function processChapters(langPrefix: string) {
  return allChapters
    .filter((entry: CollectionEntry<'novel'>) => entry.slug.startsWith(`${langPrefix}/`))
    .map((entry: CollectionEntry<'novel'>) => {
      const cleanContent = (entry.body || "").replace(/[#*`_~-]/g, "");
      const words = cleanContent.split(/\s+/).filter(Boolean).length;
      const readTime = Math.ceil(words / 200);
      const filenameNum = parseInt(entry.slug.match(/\d+$/)?.[0] || "999");
      return {
        ...entry,
        readTime,
        sortOrder: entry.data.order ?? entry.data.chapter_number ?? filenameNum,
        linkSlug: entry.slug.split('/')[1],
        lang: langPrefix
      };
    })
    .sort((a, b) => a.sortOrder - b.sortOrder);
}

const trChapters = processChapters('tr');
const enChapters = processChapters('en');
---

<Layout title="Zero Sum City">
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;700&display=swap" rel="stylesheet">

  <div class="bg-layer"></div>
  <main class="toc-container">
    <div id="resume-container" style="display: none;">
      <a id="resume-link" href="#" class="resume-banner">
        <span class="resume-label">Last Read</span>
        <span id="resume-title" class="resume-title"></span>
        <span class="resume-arrow">→</span>
      </a>
    </div>

    <header class="toc-header">
      <h1>Zero Sum City</h1>
      <p class="author">By Mahmut Tahsin Ülgen</p>
      
      <div class="theme-drawer-container">
        <button class="theme-toggle-btn" id="idx-theme-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 6px;"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
          Appearance
        </button>
        <div class="theme-options" id="idx-theme-menu">
          <button class="theme-btn light" data-set-theme="light"></button>
          <button class="theme-btn sepia" data-set-theme="sepia"></button>
          <button class="theme-btn dark" data-set-theme="dark"></button>
          <button class="clear-history-btn" id="clear-btn">✕</button>
        </div>
      </div>

      <div class="tab-wrapper">
        <div class="tabs">
          <button id="tab-en" class="tab-btn active" data-tab="en">English</button>
          <button id="tab-tr" class="tab-btn" data-tab="tr">Türkçe</button>
        </div>
      </div>
    </header>

    <section id="list-en" class="chapter-list-container">
      <div class="vertical-list">
        {enChapters.map((chapter) => (
          <a href={`/${chapter.lang}/${chapter.linkSlug}`} class="chapter-button">
            <span class="chapter-badge">Ch. {chapter.sortOrder}</span>
            <span class="chapter-name" transition:name={`title-${chapter.lang}-${chapter.sortOrder}`}>{chapter.data.title}</span>
            <span class="read-time">{chapter.readTime} min</span>
          </a>
        ))}
      </div>
    </section>

    <section id="list-tr" class="chapter-list-container" style="display: none;">
      <div class="vertical-list">
        {trChapters.map((chapter) => (
          <a href={`/${chapter.lang}/${chapter.linkSlug}`} class="chapter-button">
            <span class="chapter-badge">Bölüm {chapter.sortOrder}</span>
            <span class="chapter-name" transition:name={`title-${chapter.lang}-${chapter.sortOrder}`}>{chapter.data.title}</span>
            <span class="read-time">{chapter.readTime} dk</span>
          </a>
        ))}
      </div>
    </section>

    <footer class="index-footer">
      <div class="footer-divider"></div>
      <p class="footer-name">Zero Sum City</p>
      <p class="footer-copyright">&copy; {new Date().getFullYear()} Mahmut Tahsin Ülgen. All rights reserved.</p>
      <div class="footer-socials">
        <a href="mailto:info@tahirurge.com">Contact</a>
        <span class="dot">•</span>
        <a href="https://instagram.com/TayirDurden" target="_blank">Instagram</a>
      </div>
    </footer>
  </main>
</Layout>

<script is:inline>
  if (!window.indexInitialized) {
    document.addEventListener('click', (e) => {
      const target = e.target;
      if (target.closest('#idx-theme-trigger')) {
        e.stopPropagation();
        document.getElementById('idx-theme-menu')?.classList.toggle('active');
      }
      const themeBtn = target.closest('[data-set-theme]');
      if (themeBtn) {
        document.documentElement.setAttribute('data-theme', themeBtn.getAttribute('data-set-theme'));
        localStorage.setItem('novel-theme', themeBtn.getAttribute('data-set-theme'));
        document.getElementById('idx-theme-menu')?.classList.remove('active');
      }
      if (target.closest('[data-tab]')) {
        const lang = target.closest('[data-tab]').getAttribute('data-tab');
        localStorage.setItem('preferred-lang', lang);
        location.reload();
      }
      if (target.closest('#clear-btn')) {
        if (confirm("Clear reading progress?")) {
          localStorage.removeItem('last-read-path');
          localStorage.removeItem('last-read-title');
          Object.keys(localStorage).forEach(k => { if(k.startsWith('finished-')) localStorage.removeItem(k); });
          location.reload();
        }
      }
    });
    window.indexInitialized = true;
  }

  document.addEventListener('astro:page-load', () => {
    document.documentElement.setAttribute('data-theme', localStorage.getItem('novel-theme') || 'light');
    const lang = localStorage.getItem('preferred-lang') || 'en';
    const trList = document.getElementById('list-tr');
    const enList = document.getElementById('list-en');
    const trBtn = document.getElementById('tab-tr');
    const enBtn = document.getElementById('tab-en');
    if (trList && enList && trBtn && enBtn) {
      trList.style.display = lang === 'tr' ? 'block' : 'none';
      enList.style.display = lang === 'en' ? 'block' : 'none';
      trBtn.classList.toggle('active', lang === 'tr');
      enBtn.classList.toggle('active', lang === 'en');
    }
    const path = localStorage.getItem('last-read-path');
    const title = localStorage.getItem('last-read-title');
    const container = document.getElementById('resume-container');
    if (path && title && container) {
      document.getElementById('resume-title').textContent = title;
      document.getElementById('resume-link').href = path;
      container.style.display = 'block';
    }
    document.querySelectorAll('.chapter-button').forEach(btn => {
      const url = new URL(btn.href);
      if (localStorage.getItem('finished-' + url.pathname.replace(/\/$/, ""))) btn.classList.add('finished');
    });
  });
</script>

<style is:global>
  :root { --font-main: 'Lora', serif; --font-ui: 'Inter', sans-serif; }
  :root, [data-theme="light"] { --bg-color: transparent; --text-color: #222; --border-color: #ddd; --card-bg: rgba(255,255,255,0.85); --accent: #007aff; }
  [data-theme="sepia"] { --bg-color: transparent; --text-color: #5b4636; --border-color: #d3c9b1; --card-bg: rgba(244,236,216,0.9); --accent: #8c786a; }
  [data-theme="dark"] { --bg-color: transparent; --text-color: #e0e0e0; --border-color: #444; --card-bg: rgba(30,30,30,0.85); --accent: #bb86fc; }
  html, body { margin: 0; padding: 0; background-color: #000 !important; }
</style>

<style>
  .toc-container h1, .chapter-name, .footer-name { font-family: var(--font-main); }
  .author, .chapter-badge, .read-time, .tab-btn, .theme-toggle-btn, .resume-label, .footer-copyright, .footer-socials { font-family: var(--font-ui); }
  
  /* RESTORED: Checkmarks */
  .chapter-button.finished::after { content: '✓'; margin-left: auto; font-weight: bold; color: #2ecc71; padding-left: 10px; font-size: 1.2rem; flex-shrink: 0; }
  
  .bg-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: url('/cover.png'); background-size: cover; background-position: center; filter: blur(15px) brightness(0.9); transform: scale(1.1); }
  
  .toc-container { max-width: 700px; margin: 4rem auto; padding: 3rem; color: var(--text-color); background: var(--card-bg); backdrop-filter: blur(5px); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); border: 1px solid var(--border-color); position: relative; z-index: 10; }

  /* RESTORED: Last Read Banner Styling */
  .resume-banner { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); border: 1px solid var(--border-color); padding: 0.8rem 1.2rem; border-radius: 50px; margin-bottom: 2rem; text-decoration: none; color: var(--text-color); font-size: 0.85rem; border-left: 5px solid var(--accent); }
  .resume-label { font-weight: bold; text-transform: uppercase; font-size: 0.7rem; opacity: 0.6; margin-right: 15px; }

  /* MOBILE FONT FIXES */
  @media (max-width: 600px) {
    .toc-container { margin: 1rem; padding: 1.5rem; }
    .toc-header h1 { font-size: 2.2rem; }
    .chapter-name { font-size: 1rem !important; }
    .chapter-badge { min-width: 70px !important; font-size: 0.65rem !important; margin-right: 10px !important; }
  }

  .theme-drawer-container { position: relative; margin: 1.5rem 0 2.5rem 0; text-align: center; }
  .theme-toggle-btn { background: none; border: 1px solid var(--border-color); color: var(--text-color); padding: 8px 18px; border-radius: 20px; cursor: pointer; display: inline-flex; align-items: center; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; }
  .theme-options { position: absolute; top: 45px; left: 50%; transform: translateX(-50%) translateY(-10px); background: var(--card-bg); border: 1px solid var(--border-color); padding: 12px; border-radius: 15px; display: flex; gap: 12px; opacity: 0; pointer-events: none; transition: 0.2s; z-index: 100; align-items: center; }
  .theme-options.active { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }
  .theme-btn { width: 24px; height: 24px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.2); cursor: pointer; }
  .theme-btn.light { background: #fff !important; } .theme-btn.sepia { background: #f4ecd8 !important; } .theme-btn.dark { background: #333 !important; }
  .clear-history-btn { background: none; border: none; color: var(--text-color); cursor: pointer; opacity: 0.5; margin-left: 5px; }

  .tab-wrapper { display: flex; justify-content: center; margin-bottom: 2rem; }
  .tabs { display: inline-flex; background: rgba(0,0,0,0.05); padding: 4px; border-radius: 50px; border: 1px solid var(--border-color); }
  .tab-btn { background: none; border: none; color: var(--text-color); opacity: 0.5; cursor: pointer; font-weight: 700; padding: 8px 20px; border-radius: 40px; font-size: 0.8rem; text-transform: uppercase; }
  .tab-btn.active { opacity: 1; background: var(--card-bg); color: var(--accent); }

  .chapter-button { display: flex; align-items: center; padding: 12px 15px; text-decoration: none; color: var(--text-color); border: 1px solid var(--border-color); border-radius: 10px; background: rgba(0,0,0,0.02); margin-bottom: 8px; }
  .chapter-badge { font-weight: bold; min-width: 90px; font-size: 0.75rem; opacity: 0.7; background: var(--border-color); padding: 4px 8px; border-radius: 5px; margin-right: 15px; text-align: center; flex-shrink: 0; }
  .chapter-name { flex-grow: 1; font-size: 1.15rem; margin-right: 10px; font-weight: 700; }
  .read-time { font-size: 0.7rem; opacity: 0.5; white-space: nowrap; }
  
  .index-footer { margin-top: 4rem; text-align: center; }
  .footer-divider { width: 40px; height: 1px; background: var(--border-color); margin: 0 auto 2rem; }
  .footer-socials a { color: var(--accent); text-decoration: none; margin: 0 10px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; }
</style>