---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../layouts/Layout.astro';

const allChapters = await getCollection('novel');

function processChapters(langPrefix: string) {
  return allChapters
    .filter((entry: CollectionEntry<'novel'>) => entry.slug.startsWith(`${langPrefix}/`))
    .map((entry: CollectionEntry<'novel'>) => {
      // FIX: Strip Markdown syntax to get a more accurate word count
      const cleanContent = (entry.body || "").replace(/[#*`_~-]/g, "");
      const words = cleanContent.split(/\s+/).filter(Boolean).length;
      const readTime = Math.ceil(words / 200);

      const filenameNum = parseInt(entry.slug.match(/\d+$/)?.[0] || "999");
      return {
        ...entry,
        readTime,
        sortOrder: entry.data.order ?? entry.data.chapter_number ?? filenameNum,
        linkSlug: entry.slug.split('/')[1],
        lang: langPrefix
      };
    })
    .sort((a, b) => a.sortOrder - b.sortOrder);
}

const trChapters = processChapters('tr');
const enChapters = processChapters('en');
---

<Layout title="Zero Sum City">
  <div class="bg-layer"></div>
  <main class="toc-container">
    <div id="resume-container" style="display: none;">
      <a id="resume-link" href="#" class="resume-banner">
        <span class="resume-label">Last Read</span>
        <span id="resume-title" class="resume-title"></span>
        <span class="resume-arrow">→</span>
      </a>
    </div>

    <header class="toc-header">
      <h1>Zero Sum City</h1>
      <p class="author">By Mahmut Tahsin Ülgen</p>
      
      <div class="theme-drawer-container" id="theme-drawer">
        <button class="theme-toggle-btn" id="idx-theme-trigger" aria-label="Toggle Theme">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 6px;"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
          Appearance
        </button>
        <div class="theme-options" id="idx-theme-menu">
          <button class="theme-btn light" data-set-theme="light" title="Light Mode"></button>
          <button class="theme-btn sepia" data-set-theme="sepia" title="Sepia Mode"></button>
          <button class="theme-btn dark" data-set-theme="dark" title="Dark Mode"></button>
          <button class="clear-history-btn" id="clear-btn" title="Clear Progress">✕</button>
        </div>
      </div>

      <div class="tabs">
        <button id="tab-en" class="tab-btn active" data-tab="en">English</button>
        <span class="tab-divider">/</span>
        <button id="tab-tr" class="tab-btn" data-tab="tr">Türkçe <small class="soon-label">(Soon)</small></button>
      </div>
    </header>

    <section id="list-en" class="chapter-list-container">
      <div class="vertical-list">
        {enChapters.map((chapter) => (
          <a href={`/${chapter.lang}/${chapter.linkSlug}`} class="chapter-button">
            <span class="chapter-badge">Ch. {chapter.sortOrder}</span>
            <span class="chapter-name" transition:name={`title-${chapter.lang}-${chapter.sortOrder}`}>{chapter.data.title}</span>
            <span class="read-time">{chapter.readTime} min</span>
          </a>
        ))}
      </div>
    </section>

    <section id="list-tr" class="chapter-list-container" style="display: none;">
      <div class="vertical-list">
        {trChapters.map((chapter) => (
          <a href={`/${chapter.lang}/${chapter.linkSlug}`} class="chapter-button">
            <span class="chapter-badge">Bölüm {chapter.sortOrder}</span>
            <span class="chapter-name" transition:name={`title-${chapter.lang}-${chapter.sortOrder}`}>{chapter.data.title}</span>
            <span class="read-time">{chapter.readTime} dk</span>
          </a>
        ))}
      </div>
    </section>

    <footer class="index-footer">
      <div class="footer-divider"></div>
      <p class="footer-name">Zero Sum City</p>
      <p class="footer-copyright">
        &copy; {new Date().getFullYear()} Mahmut Tahsin Ülgen. All rights reserved.
      </p>
      <div class="footer-socials">
        <a href="mailto:your@email.com">Contact</a>
        <span class="dot">•</span>
        <a href="https://instagram.com/yourhandle" target="_blank">Instagram</a>
      </div>
    </footer>
  </main>
</Layout>

<script is:inline>
  // ... (Your script remains the same, it is perfect) ...
</script>

<style is:global>
  /* ... (Your global styles remain the same) ... */
</style>

<style>
  /* ... (Your index styles remain the same) ... */
  /* Added z-index to theme options to prevent footer overlap */
  .theme-options { z-index: 100 !important; }
</style>