---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../layouts/Layout.astro';

const allChapters = await getCollection('novel');

function processChapters(langPrefix: string) {
  return allChapters
    .filter((entry: CollectionEntry<'novel'>) => entry.slug.startsWith(`${langPrefix}/`))
    .map((entry: CollectionEntry<'novel'>) => {
      const cleanContent = (entry.body || "").replace(/[#*`_~-]/g, "");
      const words = cleanContent.split(/\s+/).filter(Boolean).length;
      const readTime = Math.ceil(words / 200);
      const filenameNum = parseInt(entry.slug.match(/\d+$/)?.[0] || "999");
      return {
        ...entry,
        readTime,
        sortOrder: entry.data.order ?? entry.data.chapter_number ?? filenameNum,
        linkSlug: entry.slug.split('/')[1],
        lang: langPrefix
      };
    })
    .sort((a, b) => a.sortOrder - b.sortOrder);
}

const trChapters = processChapters('tr');
const enChapters = processChapters('en');
---

<Layout title="Zero Sum City">
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;700&display=swap" rel="stylesheet">

  <div class="bg-layer"></div>
  <main class="toc-container">
    <div id="resume-container" style="display: none;">
      <a id="resume-link" href="#" class="resume-banner">
        <span class="resume-label">Last Read</span>
        <span id="resume-title" class="resume-title"></span>
        <span class="resume-arrow">→</span>
      </a>
    </div>

    <header class="toc-header">
      <h1>Zero Sum City</h1>
      <p class="author">By Mehmet Tahir Ürge</p>
      
      <div class="utility-bar">
        <button class="icon-toggle" id="theme-icon-toggle" aria-label="Toggle Theme">
          <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
          <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
        </button>

        <div class="tabs">
          <button id="tab-en" class="tab-btn active" data-tab="en">ENGLISH</button>
          <button id="tab-tr" class="tab-btn" data-tab="tr">TÜRKÇE</button>
        </div>
      </div>
    </header>

    <section id="list-en" class="chapter-list-container">
      <div class="vertical-list">
        {enChapters.map((chapter) => (
          <a href={`/${chapter.lang}/${chapter.linkSlug}`} class="chapter-button">
            <span class="chapter-badge">Ch. {chapter.sortOrder}</span>
            <span class="chapter-name" transition:name={`title-${chapter.lang}-${chapter.sortOrder}`}>{chapter.data.title}</span>
            <span class="read-time">{chapter.readTime} min</span>
          </a>
        ))}
      </div>
    </section>

    <section id="list-tr" class="chapter-list-container" style="display: none;">
      <div class="vertical-list">
        {trChapters.map((chapter) => (
          <a href={`/${chapter.lang}/${chapter.linkSlug}`} class="chapter-button">
            <span class="chapter-badge">Bölüm {chapter.sortOrder}</span>
            <span class="chapter-name" transition:name={`title-${chapter.lang}-${chapter.sortOrder}`}>{chapter.data.title}</span>
            <span class="read-time">{chapter.readTime} dk</span>
          </a>
        ))}
      </div>
    </section>

    <footer class="index-footer">
      <div class="footer-divider"></div>
      <p class="footer-name">Zero Sum City</p>
      <p class="footer-copyright">&copy; {new Date().getFullYear()} Mehmet Tahir Ürge. All rights reserved.</p>
      <div class="footer-socials">
        <a href="mailto:info@tahirurge.com">Contact</a>
        <span class="dot">•</span>
        <a href="https://instagram.com/TayirDurden" target="_blank">Instagram</a>
      </div>
    </footer>
  </main>
</Layout>

<script is:inline>
  function updateThemeIcons(theme) {
    const sun = document.querySelector('.sun-icon');
    const moon = document.querySelector('.moon-icon');
    if (theme === 'dark') {
      sun.style.display = 'none';
      moon.style.display = 'block';
    } else {
      sun.style.display = 'block';
      moon.style.display = 'none';
    }
  }

  if (!window.indexInitialized) {
    document.addEventListener('click', (e) => {
      const target = e.target;
      
      if (target.closest('#resume-link')) {
        const href = document.getElementById('resume-link').href;
        if (href && href !== window.location.href + '#') {
          window.location.href = href;
        }
        return;
      }

      if (target.closest('#theme-icon-toggle')) {
        const current = document.documentElement.getAttribute('data-theme') || 'light';
        const next = current === 'light' ? 'dark' : (current === 'dark' ? 'sepia' : 'light');
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('novel-theme', next);
        updateThemeIcons(next);
      }

      if (target.closest('[data-tab]')) {
        const lang = target.closest('[data-tab]').getAttribute('data-tab');
        localStorage.setItem('preferred-lang', lang);
        location.reload();
      }
    });
    window.indexInitialized = true;
  }

  document.addEventListener('astro:page-load', () => {
    const theme = localStorage.getItem('novel-theme') || 'light';
    document.documentElement.setAttribute('data-theme', theme);
    updateThemeIcons(theme);

    const lang = localStorage.getItem('preferred-lang') || 'en';
    const trList = document.getElementById('list-tr'), enList = document.getElementById('list-en');
    const trBtn = document.getElementById('tab-tr'), enBtn = document.getElementById('tab-en');
    if (trList && enList) {
      trList.style.display = lang === 'tr' ? 'block' : 'none';
      enList.style.display = lang === 'en' ? 'block' : 'none';
      trBtn.classList.toggle('active', lang === 'tr');
      enBtn.classList.toggle('active', lang === 'en');
    }

    const path = localStorage.getItem('last-read-path'), title = localStorage.getItem('last-read-title');
    if (path && title && document.getElementById('resume-container')) {
      document.getElementById('resume-title').textContent = title;
      document.getElementById('resume-link').href = path;
      document.getElementById('resume-container').style.display = 'block';
    }

    document.querySelectorAll('.chapter-button').forEach(btn => {
      const url = new URL(btn.href);
      if (localStorage.getItem('finished-' + url.pathname.replace(/\/+$/g, ""))) btn.classList.add('finished');
    });
  });
</script>

<style is:global>
  :root { --font-main: 'Lora', serif; --font-ui: 'Inter', sans-serif; }
  :root, [data-theme="light"] { --bg-color: transparent; --text-color: #222; --border-color: #ddd; --card-bg: rgba(255,255,255,0.85); --accent: #007aff; }
  [data-theme="sepia"] { --bg-color: transparent; --text-color: #5b4636; --border-color: #d3c9b1; --card-bg: rgba(244,236,216,0.9); --accent: #8c786a; }
  [data-theme="dark"] { --bg-color: transparent; --text-color: #e0e0e0; --border-color: #444; --card-bg: rgba(30,30,30,0.85); --accent: #bb86fc; }
  html, body { margin: 0; padding: 0; background-color: #000 !important; }
</style>

<style>
  .toc-container h1, .chapter-name, .footer-name { font-family: var(--font-main); }
  .author, .chapter-badge, .read-time, .tab-btn, .resume-label, .footer-copyright { font-family: var(--font-ui); }
  
  .chapter-button.finished::after { content: '✓'; margin-left: auto; font-weight: bold; color: #2ecc71; padding-left: 10px; font-size: 1.2rem; flex-shrink: 0; }
  .bg-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: url('/cover.png'); background-size: cover; background-position: center; filter: blur(15px) brightness(0.9); transform: scale(1.1); }
  .toc-container { max-width: 700px; margin: 4rem auto; padding: 3rem; color: var(--text-color); background: var(--card-bg); backdrop-filter: blur(5px); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); border: 1px solid var(--border-color); position: relative; z-index: 10; }

  .resume-banner { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); border: 1px solid var(--border-color); padding: 0.8rem 1.2rem; border-radius: 50px; margin-bottom: 2rem; text-decoration: none; color: var(--text-color); font-size: 0.85rem; border-left: 5px solid var(--accent); }

  .toc-header { text-align: center; margin-bottom: 1.5rem; }
  .toc-header h1 { font-size: 3rem; margin-bottom: 0.5rem; }
  .author { opacity: 0.7; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 1rem; }

  /* SIDE-BY-SIDE UTILITY BAR */
  .utility-bar { display: flex; justify-content: center; align-items: center; gap: 12px; margin-bottom: 1.5rem; }
  .icon-toggle { background: none; border: 1px solid var(--border-color); color: var(--text-color); width: 40px; height: 36px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
  .icon-toggle:hover { background: rgba(0,0,0,0.05); }

  .tabs { display: inline-flex; background: rgba(0,0,0,0.05); padding: 3px; border-radius: 50px; border: 1px solid var(--border-color); height: 36px; align-items: center; }
  .tab-btn { background: none; border: none; color: var(--text-color); opacity: 0.5; cursor: pointer; font-weight: 700; padding: 0 16px; height: 100%; border-radius: 30px; font-size: 0.75rem; transition: 0.2s; }
  .tab-btn.active { opacity: 1; background: var(--card-bg); color: var(--accent); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

  @media (max-width: 600px) {
    .toc-container { margin: 1rem; padding: 1.5rem; }
    .toc-header h1 { font-size: 2.2rem; }
    .chapter-name { font-size: 1rem !important; }
  }

  .chapter-button { display: flex; align-items: center; padding: 12px 15px; text-decoration: none; color: var(--text-color); border: 1px solid var(--border-color); border-radius: 10px; background: rgba(0,0,0,0.02); margin-bottom: 8px; }
  .chapter-badge { font-weight: bold; min-width: 85px; font-size: 0.7rem; opacity: 0.7; background: var(--border-color); padding: 4px 8px; border-radius: 5px; margin-right: 15px; text-align: center; flex-shrink: 0; }
  .chapter-name { flex-grow: 1; font-size: 1.1rem; margin-right: 10px; font-weight: 700; }
  .read-time { font-size: 0.7rem; opacity: 0.5; }
  
  .index-footer { margin-top: 3rem; text-align: center; }
  .footer-divider { width: 40px; height: 1px; background: var(--border-color); margin: 0 auto 1.5rem; }
  .footer-socials a { color: var(--accent); text-decoration: none; margin: 0 10px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; }
</style>